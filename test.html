<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OneKit 2.0.2 Book List</title>
<style>
    /* --- General Styling --- */
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
        color: #333;
    }

    #app-title {
        text-align: center;
        color: #333;
        margin-bottom: 20px;
    }

    /* --- Grid Layout for Book List --- */
    #list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
        gap: 20px;
    }

    /* --- Book Card Styling --- */
    .book-card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .book-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    /* --- Favorite State Styling --- */
    .book-card.favorited {
        border-color: #ffc107;
        background-color: #fffef5;
    }

    .book-img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .title {
        font-size: 1.1em;
        font-weight: bold;
        margin-bottom: 8px;
        line-height: 1.4;
        /* Prevents long titles from breaking the layout */
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .meta {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 15px;
    }

    /* --- Button Styling --- */
    .buttons {
        margin-top: auto;
        display: flex;
        gap: 10px;
    }

    .btn {
        text-decoration: none;
        padding: 10px 15px;
        border-radius: 8px;
        color: white;
        font-size: 0.9em;
        text-align: center;
        flex: 1;
        transition: background-color 0.2s, transform 0.1s;
        border: none;
        cursor: pointer;
        font-family: inherit;
    }

    .btn:active {
        transform: scale(0.97);
    }

    .btn-read {
        background: #007bff;
    }
    .btn-read:hover {
        background: #0056b3;
    }

    .btn-down {
        background: #28a745;
    }
    .btn-down:hover {
        background: #1e7e34;
    }
    
    .btn-favorite {
        background: #6c757d;
        font-size: 1.2em;
        line-height: 1;
        padding: 10px;
    }
    .btn-favorite.is-favorite {
        background: #ffc107;
        color: #333;
    }

    /* --- Status Message Styling --- */
    .loading, .error, .no-data {
        font-size: 1.2em;
        text-align: center;
        padding: 60px 20px;
        color: #555;
        grid-column: 1 / -1; /* Make it span all columns */
    }
</style>
</head>

<body>
    <h1 id="app-title">üìö OneKit Book List</h1>
    
    <!-- This loader will be automatically shown/hidden by ok.http -->
    <p id="loader" class="loading" style="display: none;">Loading books...</p>
    
    <div id="list"></div>

    <!-- Include the OneKit 2.0.2 library -->
    <!-- IMPORTANT: 'onekit.js' must be in the same folder as this HTML file -->
    <script src="./onekit.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // The API endpoint for fetching book data
    const API_URL = "https://script.google.com/macros/s/AKfycbzVCC93V8GClQGNRJIBRH7CeBG9vzxE5zvfc280D8oH78BJQwKMZ9X3ddQo_r7u4uzX/exec";

    // ==================== 1. REACTIVE STATE ====================
    // Central state for the entire application. Changes here will automatically update the UI.
    const appState = ok.reactive.reactive({
        books: [],          // Array of book objects
        status: 'idle',     // 'idle', 'loading', 'success', 'error', 'empty'
        favorites: new Set() // A Set of book IDs that are favorited
    });

    // ==================== 2. COMPONENT DEFINITION ====================
    // A reusable component for displaying a single book card.
    ok.component.register('book-card', {
        // Props are data passed down from the parent
        props: ['book', 'isFavorite'],

        // The render function returns the HTML for the component
        render: function() {
            const book = this.props.book;
            const favClass = this.props.isFavorite ? 'is-favorite' : '';
            const cardClass = this.props.isFavorite ? 'favorited' : '';

            // Using template literals for clean HTML generation
            return `<div class="book-card ${cardClass}">
                    <img src="${book.icon}" class="book-img" alt="${book.name} Cover" />
                    <div class="title">${book.name}</div>
                    <div class="meta">${book.page} pages | ${book.mb} MB</div>
                    <div class="buttons">
                        <a class="btn btn-read" href="${book.read}" target="_blank">Read</a>
                        <a class="btn btn-down" href="${book.down}" target="_blank">Download</a>
                        <button class="btn btn-favorite ${favClass}" data-id="${book.id}">‚òÖ</button>
                    </div>
                </div>`;
        },

        // The mounted hook is called after the component is added to the DOM
        mounted: function() {
            // Use OneKit's event delegation on the component's root element
            ok(this.element).on('click', '.btn-favorite', (event) => {
                event.stopPropagation(); // Prevent the card click event
                const bookId = event.target.dataset.id;
                toggleFavorite(bookId);
            });
        }
    });

    // ==================== 3. MAIN APP LOGIC ====================
    
    /**
     * Toggles the favorite status of a book.
     * @param {string} bookId - The ID of the book to toggle.
     */
    function toggleFavorite(bookId) {
        if (appState.favorites.has(bookId)) {
            appState.favorites.delete(bookId);
        } else {
            appState.favorites.add(bookId);
        }
        // To trigger reactivity for a Set, we must re-assign it.
        appState.favorites = new Set(appState.favorites);
    }

    /**
     * Renders the entire application based on the current state.
     */
    function renderApp() {
        const listContainer = ok('#list');
        listContainer.html(''); // Clear previous content

        switch (appState.status) {
            case 'error':
                listContainer.html('<p class="error">‚ùå Failed to load books. Please try again later.</p>');
                break;
            case 'empty':
                listContainer.html('<p class="no-data">üì≠ No books found.</p>');
                break;
            case 'success':
                if (appState.books.length === 0) {
                    appState.status = 'empty';
                    return;
                }
                appState.books.forEach(book => {
                    const isFav = appState.favorites.has(book.id);
                    // Create a new component instance with props
                    const component = ok.component.create('book-card', { book, isFavorite: isFav });
                    // Mount the component into the DOM
                    ok.component.mount(component, '#list');
                });
                break;
        }
    }

    // Watch for changes in the state and re-render the app
    ok.reactive.watch('status', renderApp);
    ok.reactive.watch('books', renderApp);
    ok.reactive.watch('favorites', renderApp);

    // ==================== 4. DATA FETCHING (USING ONEKIT) ====================
    /**
     * Fetches book data from the API.
     */
    function loadData() {
        appState.status = 'idle'; // Reset status before fetching
        
        ok.http.get(API_URL, { loader: '#loader' })
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    appState.status = 'empty';
                } else {
                    appState.books = data.map(book => ({
                        ...book,
                        // Create a unique, URL-friendly ID from the book name
                        id: book.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
                    }));
                    appState.status = 'success';
                }
            })
            .catch(err => {
                // --- ROBUST ERROR HANDLING ---
                // NOTE: An 'AbortError' is common and is NOT a true API failure.
                // It is often caused by browser extensions (e.g., ad blockers, privacy shields)
                // that cancel the request. The code below correctly identifies this,
                // logs a non-critical warning, and prevents the app from showing an error message.
                if (err.name === 'AbortError') {
                    console.warn("Request was aborted, possibly due to a browser extension or page navigation.");
                    return; 
                }

                // Handle other, genuine network or server errors
                console.error("API Error:", err);
                appState.status = 'error';
            });
    }

    // Initial load of data when the page loads
    loadData();
});
</script>

</body>
</html>